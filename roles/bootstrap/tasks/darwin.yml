- name: Install Xcode Command Line Tools Catalina +
  block:
    - stat:
        path: /Library/Developer/CommandLineTools
      register: xcode

    - name: Install Xcode Command Line Tools w/ UI
      shell: xcode-select --install
      when: not xcode.stat.exists

  when: ansible_facts['distribution_version'] is version('10.15.0', '>=')

- name: touch installondemand file
  file:
    state: touch
    path: /tmp/.com.apple.dt.CommandLineTools.installondemand.in-progress

- name: Install Xcode CLI Tools
  shell: |
    PROD=$(softwareupdate -l | grep "\*.*Command Line" | head -n 1 | awk -F"*" '{print $2}' | sed -e 's/^ *//' | tr -d '\n')
    softwareupdate -i "$PROD"

- name: remove installondemand file
  file:
    state: absent
    path: /tmp/.com.apple.dt.CommandLineTools.installondemand.in-progress

- name: alias xcrun git to git in zshrc
  copy:
    dest: "/Users/{{ ansible_user_id }}/.profile"
    content: alias git='xcrun git'

- name: curl homebrew
  block:
    - stat:
        path: /usr/local/homebrew
      register: homebrew

    - name: rm -rf /usr/local/homebrew
      file:
        path: /usr/local/homebrew
        state: absent
      when: homebrew.stat.exists
      become: yes

    - name: ensure homebrew dir exists
      file:
        path: /usr/local/homebrew
        state: directory
        mode: 0755
        owner: "{{ ansible_user_id }}"
        group: "{{ ansible_user_gid }}"
      become: yes

    - shell: cd /usr/local/src && curl -L https://github.com/Homebrew/brew/tarball/master | tar xz --strip 1 -C /usr/local/homebrew

    - shell: sudo chown -R $(whoami) /usr/local/share/man/man8

    - name: check if man8 file exists
      stat:
        path: /usr/local/share/man/man8
      register: man8
      ignore_errors: yes

    - name: change ownership on man8
      file:
        path: /usr/local/share/man/man8
        owner: "{{ ansible_user_id }}"
      when: man8.stat.exists
      become: yes

- name: add homebrew binaries to path
  copy:
    dest: "/Users/{{ ansible_user_id }}/.profile"
    content: export PATH=$PATH:/usr/local/homebrew/bin

- name: update homebrew
  homebrew:
    update_homebrew: yes

- name: install coreutils
  homebrew:
    name: coreutils
    state: latest

- name: install jq
  homebrew:
    name: jq
    state: latest
